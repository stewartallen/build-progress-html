<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>RV-10 Build Progress</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
                    Cantarell, sans-serif;
                background-color: #0d1117;
                color: #c9d1d9;
                padding: 20px;
                line-height: 1.6;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
            }

            header {
                margin-bottom: 40px;
            }

            h1 {
                font-size: 2.5em;
                font-weight: 600;
                margin-bottom: 10px;
                color: #f0f6fc;
            }

            .subtitle {
                font-size: 1.1em;
                color: #8b949e;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 40px;
            }

            .stat-card {
                background-color: #161b22;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 20px;
            }

            .stat-label {
                font-size: 0.875em;
                color: #8b949e;
                margin-bottom: 8px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .stat-value {
                font-size: 1.8em;
                font-weight: 600;
                color: #58a6ff;
            }

            .stat-secondary {
                font-size: 0.9em;
                color: #8b949e;
                margin-top: 4px;
            }

            .chart-section {
                margin-top: 40px;
            }

            .year-section {
                margin-bottom: 40px;
            }

            .year-header {
                font-size: 1.5em;
                font-weight: 600;
                margin-bottom: 15px;
                color: #f0f6fc;
            }

            .chart-container {
                background-color: #161b22;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 20px;
                overflow-x: auto;
            }

            .chart-wrapper {
                display: flex;
                gap: 10px;
                margin-top: 10px;
            }

            .day-labels {
                display: flex;
                flex-direction: column;
                gap: 3px;
                padding-top: 20px;
                font-size: 0.7em;
                color: #8b949e;
            }

            .day-label {
                height: 12px;
                line-height: 12px;
            }

            .grid-container {
                flex: 1;
            }

            .month-labels {
                display: flex;
                margin-bottom: 5px;
                font-size: 0.7em;
                color: #8b949e;
                height: 15px;
            }

            .month-label {
                text-align: left;
                padding-left: 2px;
                flex-shrink: 0;
            }

            .contribution-grid {
                display: grid;
                grid-template-rows: repeat(7, 12px);
                grid-auto-flow: column;
                gap: 3px;
            }

            .day-cell {
                width: 12px;
                height: 12px;
                border-radius: 2px;
                cursor: pointer;
                transition: transform 0.1s ease;
            }

            .day-cell:hover {
                transform: scale(1.5);
                border: 1px solid #8b949e;
            }

            /* Color scale for hours worked */
            .level-0 {
                background-color: #151b23;
            }
            .level-1 {
                background-color: #0e4429;
            }
            .level-2 {
                background-color: #006d32;
            }
            .level-3 {
                background-color: #26a641;
            }
            .level-4 {
                background-color: #39d353;
            }

            .legend {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-top: 15px;
                font-size: 0.85em;
                color: #8b949e;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .legend-scale {
                display: flex;
                gap: 3px;
            }

            .legend-box {
                width: 12px;
                height: 12px;
                border-radius: 2px;
            }

            .tooltip {
                position: fixed;
                background-color: #1c2128;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 8px 12px;
                pointer-events: none;
                z-index: 1000;
                display: none;
                font-size: 0.875em;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            }

            .tooltip-date {
                font-weight: 600;
                margin-bottom: 4px;
            }

            .tooltip-hours {
                color: #58a6ff;
            }

            .loading {
                text-align: center;
                padding: 40px;
                font-size: 1.2em;
                color: #8b949e;
            }

            .error {
                background-color: #f85149;
                color: #fff;
                padding: 20px;
                border-radius: 6px;
                margin: 20px 0;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>RV-10 Build Progress</h1>
                <p class="subtitle">Aircraft Kit Construction Tracker</p>
            </header>

            <div id="stats-container" class="stats-grid">
                <div class="loading">Loading statistics...</div>
            </div>

            <div id="chart-container" class="chart-section">
                <div class="loading">Loading build progress chart...</div>
            </div>
        </div>

        <div id="tooltip" class="tooltip"></div>

        <script>
            const DATA_FILE = 'progress.json';

            // Color level thresholds (hours per day)
            const COLOR_THRESHOLDS = [0, 2, 4, 6, 8];

            function getColorLevel(hours) {
                if (hours === 0) return 0;
                if (hours < COLOR_THRESHOLDS[1]) return 1;
                if (hours < COLOR_THRESHOLDS[2]) return 2;
                if (hours < COLOR_THRESHOLDS[3]) return 3;
                return 4;
            }

            function formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                });
            }

            function formatHours(hours) {
                return hours === 1 ? '1 hour' : `${hours} hours`;
            }

            function renderStatistics(stats) {
                const container = document.getElementById('stats-container');

                const percentComplete = ((stats.total_hours / 2500) * 100).toFixed(1);
                const remainingHours = (2500 - stats.total_hours).toFixed(1);

                container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Hours</div>
                    <div class="stat-value">${stats.total_hours.toFixed(1)}</div>
                    <div class="stat-secondary">${percentComplete}% of 2,500 hour goal</div>
                    <div class="stat-secondary">${remainingHours} hours remaining</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Days Worked</div>
                    <div class="stat-value">${stats.days_worked}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average Per Week</div>
                    <div class="stat-value">${stats.avg_hours_per_week.toFixed(1)}</div>
                    <div class="stat-secondary">Last 6 weeks: ${stats.avg_hours_last_6_weeks.toFixed(1)} hrs/week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Current Week</div>
                    <div class="stat-value">${stats.hours_current_week.toFixed(1)}</div>
                    <div class="stat-secondary">Month: ${stats.hours_current_month.toFixed(1)} hrs</div>
                    <div class="stat-secondary">Last 30 days: ${stats.hours_last_30_days.toFixed(1)} hrs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Est. Completion</div>
                    <div class="stat-value">${new Date(stats.est_completion_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</div>
                    <div class="stat-secondary">Based on overall average</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Est. Completion (6-week trend)</div>
                    <div class="stat-value">${new Date(stats.est_completion_date_6_weeks).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</div>
                    <div class="stat-secondary">Based on recent pace</div>
                </div>
            `;
            }

            function renderChart(log) {
                // Group log entries by year
                const logByYear = {};
                log.forEach((entry) => {
                    const year = entry.date.substring(0, 4);
                    if (!logByYear[year]) {
                        logByYear[year] = [];
                    }
                    logByYear[year].push(entry);
                });

                const container = document.getElementById('chart-container');
                container.innerHTML = '';

                // Render each year
                Object.keys(logByYear)
                    .sort()
                    .forEach((year) => {
                        const yearSection = document.createElement('div');
                        yearSection.className = 'year-section';

                        const yearHeader = document.createElement('div');
                        yearHeader.className = 'year-header';
                        yearHeader.textContent = year;

                        const chartContainer = document.createElement('div');
                        chartContainer.className = 'chart-container';

                        // Get first and last date of year
                        const yearEntries = logByYear[year];
                        const firstDate = new Date(yearEntries[0].date);
                        const lastDate = new Date(yearEntries[yearEntries.length - 1].date);

                        // Create a map for quick lookup
                        const hoursMap = {};
                        yearEntries.forEach((entry) => {
                            hoursMap[entry.date] = entry.hours;
                        });

                        // Start from the first Sunday on or before the first date
                        const startDate = new Date(firstDate);
                        startDate.setDate(startDate.getDate() - startDate.getDay());

                        // End at the last Saturday on or after the last date
                        const endDate = new Date(lastDate);
                        endDate.setDate(endDate.getDate() + (6 - endDate.getDay()));

                        // Create chart wrapper with labels
                        const chartWrapper = document.createElement('div');
                        chartWrapper.className = 'chart-wrapper';

                        // Create day labels (Mon, Wed, Fri)
                        const dayLabels = document.createElement('div');
                        dayLabels.className = 'day-labels';
                        const dayNames = ['', 'Mon', '', 'Wed', '', 'Fri', ''];
                        dayNames.forEach((name) => {
                            const label = document.createElement('div');
                            label.className = 'day-label';
                            label.textContent = name;
                            dayLabels.appendChild(label);
                        });

                        // Create grid container
                        const gridContainer = document.createElement('div');
                        gridContainer.className = 'grid-container';

                        // Create month labels
                        const monthLabels = document.createElement('div');
                        monthLabels.className = 'month-labels';

                        // Track months for labels
                        const monthNames = [
                            'Jan',
                            'Feb',
                            'Mar',
                            'Apr',
                            'May',
                            'Jun',
                            'Jul',
                            'Aug',
                            'Sep',
                            'Oct',
                            'Nov',
                            'Dec',
                        ];
                        let lastMonth = -1;
                        let weekCount = 0;

                        // Calculate total weeks
                        const tempDate = new Date(startDate);
                        let totalWeeks = 0;
                        while (tempDate <= endDate) {
                            totalWeeks++;
                            tempDate.setDate(tempDate.getDate() + 7);
                        }

                        // Build month label positions with week counts
                        const monthPositions = [];
                        tempDate.setTime(startDate.getTime());
                        weekCount = 0;
                        while (weekCount < totalWeeks) {
                            const month = tempDate.getMonth();
                            if (month !== lastMonth) {
                                monthPositions.push({
                                    startWeek: weekCount,
                                    month: month,
                                    weeks: 0,
                                });
                                lastMonth = month;
                            }
                            if (monthPositions.length > 0) {
                                monthPositions[monthPositions.length - 1].weeks++;
                            }
                            weekCount++;
                            tempDate.setDate(tempDate.getDate() + 7);
                        }

                        // Create month label elements with proper widths
                        monthPositions.forEach((pos) => {
                            const label = document.createElement('div');
                            label.className = 'month-label';
                            // Width = (weeks * 12px cell) + ((weeks - 1) * 3px gap)
                            const width = pos.weeks * 12 + (pos.weeks - 1) * 3;
                            label.style.width = width + 'px';
                            label.textContent = monthNames[pos.month];
                            monthLabels.appendChild(label);
                        });

                        gridContainer.appendChild(monthLabels);

                        // Create contribution grid
                        const grid = document.createElement('div');
                        grid.className = 'contribution-grid';

                        // Generate all days
                        const currentDate = new Date(startDate);
                        while (currentDate <= endDate) {
                            const dateStr = currentDate.toISOString().split('T')[0];
                            const hours = hoursMap[dateStr] || 0;
                            const level = getColorLevel(hours);

                            const cell = document.createElement('div');
                            cell.className = `day-cell level-${level}`;
                            cell.dataset.date = dateStr;
                            cell.dataset.hours = hours;

                            // Tooltip event handlers
                            cell.addEventListener('mouseenter', showTooltip);
                            cell.addEventListener('mouseleave', hideTooltip);
                            cell.addEventListener('mousemove', moveTooltip);

                            grid.appendChild(cell);
                            currentDate.setDate(currentDate.getDate() + 1);
                        }

                        gridContainer.appendChild(grid);
                        chartWrapper.appendChild(dayLabels);
                        chartWrapper.appendChild(gridContainer);

                        // Add legend
                        const legend = document.createElement('div');
                        legend.className = 'legend';
                        legend.innerHTML = `
                    <span>Less</span>
                    <div class="legend-scale">
                        <div class="legend-box level-0"></div>
                        <div class="legend-box level-1"></div>
                        <div class="legend-box level-2"></div>
                        <div class="legend-box level-3"></div>
                        <div class="legend-box level-4"></div>
                    </div>
                    <span>More</span>
                `;

                        chartContainer.appendChild(chartWrapper);
                        chartContainer.appendChild(legend);
                        yearSection.appendChild(yearHeader);
                        yearSection.appendChild(chartContainer);
                        container.appendChild(yearSection);
                    });
            }

            function showTooltip(event) {
                const tooltip = document.getElementById('tooltip');
                const date = event.target.dataset.date;
                const hours = parseFloat(event.target.dataset.hours);

                tooltip.innerHTML = `
                <div class="tooltip-date">${formatDate(date)}</div>
                <div class="tooltip-hours">${formatHours(hours)}</div>
            `;
                tooltip.style.display = 'block';
                moveTooltip(event);
            }

            function hideTooltip() {
                const tooltip = document.getElementById('tooltip');
                tooltip.style.display = 'none';
            }

            function moveTooltip(event) {
                const tooltip = document.getElementById('tooltip');
                tooltip.style.left = event.clientX + 15 + 'px';
                tooltip.style.top = event.clientY + 15 + 'px';
            }

            async function loadData() {
                try {
                    const response = await fetch(DATA_FILE);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${DATA_FILE}: ${response.statusText}`);
                    }
                    const data = await response.json();

                    renderStatistics(data.statistics);
                    renderChart(data.log);
                } catch (error) {
                    console.error('Error loading data:', error);
                    document.getElementById('stats-container').innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
                    document.getElementById('chart-container').innerHTML = '';
                }
            }

            // Load data when page loads
            loadData();
        </script>
    </body>
</html>
