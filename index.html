<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>RV-10 Build Progress</title>

        <!-- Cal-Heatmap CSS -->
        <link rel="stylesheet" href="https://unpkg.com/cal-heatmap@4.2.4/dist/cal-heatmap.css" />

        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
                    Cantarell, sans-serif;
                background-color: #0d1117;
                color: #c9d1d9;
                padding: 20px;
                line-height: 1.6;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
            }

            header {
                margin-bottom: 40px;
            }

            h1 {
                font-size: 2.5em;
                font-weight: 600;
                margin-bottom: 10px;
                color: #f0f6fc;
            }

            .subtitle {
                font-size: 1.1em;
                color: #8b949e;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 40px;
            }

            .stat-card {
                background-color: #161b22;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 20px;
            }

            .stat-label {
                font-size: 0.875em;
                color: #8b949e;
                margin-bottom: 8px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .stat-value {
                font-size: 1.8em;
                font-weight: 600;
                color: #58a6ff;
            }

            .stat-secondary {
                font-size: 0.9em;
                color: #8b949e;
                margin-top: 4px;
            }

            .chart-section {
                margin-top: 40px;
            }

            .year-section {
                margin-bottom: 40px;
            }

            .year-header {
                font-size: 1.5em;
                font-weight: 600;
                margin-bottom: 15px;
                color: #f0f6fc;
            }

            .chart-container {
                background-color: #161b22;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 20px;
                overflow-x: auto;
            }

            .chart-wrapper {
                display: flex;
                gap: 10px;
                margin-top: 10px;
            }

            .day-labels {
                display: flex;
                flex-direction: column;
                gap: 3px;
                padding-top: 20px;
                font-size: 0.7em;
                color: #8b949e;
            }

            .day-label {
                height: 12px;
                line-height: 12px;
            }

            .grid-container {
                flex: 1;
            }

            .month-labels {
                display: flex;
                margin-bottom: 5px;
                font-size: 0.7em;
                color: #8b949e;
                height: 15px;
            }

            .month-label {
                text-align: left;
                padding-left: 2px;
                flex-shrink: 0;
            }

            .contribution-grid {
                display: grid;
                grid-template-rows: repeat(7, 12px);
                grid-auto-flow: column;
                gap: 3px;
            }

            .day-cell {
                width: 12px;
                height: 12px;
                border-radius: 2px;
                cursor: pointer;
                transition: transform 0.1s ease;
            }

            .day-cell:hover {
                transform: scale(1.5);
                border: 1px solid #8b949e;
            }

            /* Color scale for hours worked */
            .level-0 {
                background-color: #30363d;
            }
            .level-1 {
                background-color: #0e4429;
            }
            .level-2 {
                background-color: #006d32;
            }
            .level-3 {
                background-color: #26a641;
            }
            .level-4 {
                background-color: #39d353;
            }

            .legend {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-top: 15px;
                font-size: 0.85em;
                color: #8b949e;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .legend-scale {
                display: flex;
                gap: 3px;
            }

            .legend-box {
                width: 12px;
                height: 12px;
                border-radius: 2px;
            }

            .tooltip {
                position: fixed;
                background-color: #1c2128;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 8px 12px;
                pointer-events: none;
                z-index: 1000;
                display: none;
                font-size: 0.875em;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            }

            .tooltip-date {
                font-weight: 600;
                margin-bottom: 4px;
            }

            .tooltip-hours {
                color: #58a6ff;
            }

            .loading {
                text-align: center;
                padding: 40px;
                font-size: 1.2em;
                color: #8b949e;
            }

            .error {
                background-color: #f85149;
                color: #fff;
                padding: 20px;
                border-radius: 6px;
                margin: 20px 0;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>RV-10 Build Progress</h1>
            </header>

            <div id="stats-container" class="stats-grid">
                <div class="loading">Loading statistics...</div>
            </div>

            <div id="chart-container" class="chart-section">
                <div class="loading">Loading build progress chart...</div>
            </div>
        </div>

        <div id="tooltip" class="tooltip"></div>

        <!-- Cal-Heatmap JavaScript (v4) - CDN installation per official docs -->
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://unpkg.com/cal-heatmap/dist/cal-heatmap.min.js"></script>
        <script src="https://unpkg.com/@popperjs/core@2"></script>
        <script src="https://unpkg.com/cal-heatmap/dist/plugins/Tooltip.min.js"></script>
        <script src="https://unpkg.com/cal-heatmap/dist/plugins/CalendarLabel.min.js"></script>

        <script>

            const DATA_FILE = 'progress.json';

            console.log('Modules loaded successfully');

            function renderStatistics(stats) {
                const container = document.getElementById('stats-container');

                const percentComplete = ((stats.total_hours / 2500) * 100).toFixed(1);
                const remainingHours = (2500 - stats.total_hours).toFixed(1);

                container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Hours</div>
                    <div class="stat-value">${stats.total_hours.toFixed(1)}</div>
                    <div class="stat-secondary">${percentComplete}% of 2,500 hour goal</div>
                    <div class="stat-secondary">${remainingHours} hours remaining</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Days Worked</div>
                    <div class="stat-value">${stats.days_worked}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average Per Week</div>
                    <div class="stat-value">${stats.avg_hours_per_week.toFixed(1)}</div>
                    <div class="stat-secondary">Last 6 weeks: ${stats.avg_hours_last_6_weeks.toFixed(1)} hrs/week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Current Week</div>
                    <div class="stat-value">${stats.hours_current_week.toFixed(1)}</div>
                    <div class="stat-secondary">Month: ${stats.hours_current_month.toFixed(1)} hrs</div>
                    <div class="stat-secondary">Last 30 days: ${stats.hours_last_30_days.toFixed(1)} hrs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Est. Completion</div>
                    <div class="stat-value">${new Date(stats.est_completion_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</div>
                    <div class="stat-secondary">Based on overall average</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Est. Completion (6-week trend)</div>
                    <div class="stat-value">${new Date(stats.est_completion_date_6_weeks).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</div>
                    <div class="stat-secondary">Based on recent pace</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Current Streak</div>
                    <div class="stat-value">${stats.current_streak}</div>
                    <div class="stat-secondary">${stats.current_streak === 1 ? 'day' : 'days'} worked consecutively</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Record Streak</div>
                    <div class="stat-value">${stats.record_streak.days}</div>
                    <div class="stat-secondary">${stats.record_streak.days === 1 ? 'day' : 'days'} starting ${new Date(stats.record_streak.start_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</div>
                </div>
            `;
            }

            function renderChart(log) {
                // Group log entries by year
                const logByYear = {};
                log.forEach((entry) => {
                    const year = entry.date.substring(0, 4);
                    if (!logByYear[year]) {
                        logByYear[year] = [];
                    }
                    logByYear[year].push(entry);
                });

                const container = document.getElementById('chart-container');
                container.innerHTML = '';

                // Add legend once at the top
                const legend = document.createElement('div');
                legend.className = 'legend';
                legend.style.marginBottom = '20px';
                legend.innerHTML = `
                    <span>Less</span>
                    <div class="legend-scale">
                        <div class="legend-box level-0"></div>
                        <div class="legend-box level-1"></div>
                        <div class="legend-box level-2"></div>
                        <div class="legend-box level-3"></div>
                        <div class="legend-box level-4"></div>
                    </div>
                    <span>More</span>
                `;
                container.appendChild(legend);

                // Render each year (newest first)
                Object.keys(logByYear)
                    .sort()
                    .reverse()
                    .forEach((year) => {
                        const yearSection = document.createElement('div');
                        yearSection.className = 'year-section';

                        const yearHeader = document.createElement('div');
                        yearHeader.className = 'year-header';
                        yearHeader.textContent = year;

                        const chartContainer = document.createElement('div');
                        chartContainer.className = 'chart-container';
                        chartContainer.id = `cal-heatmap-${year}`;

                        yearSection.appendChild(yearHeader);
                        yearSection.appendChild(chartContainer);
                        container.appendChild(yearSection);

                        // Initialize cal-heatmap for this year (GitHub style)
                        const cal = new CalHeatmap();
                        cal.paint(
                            {
                                itemSelector: `#cal-heatmap-${year}`,
                                data: {
                                    source: logByYear[year],
                                    x: 'date',
                                    y: 'hours',
                                    defaultValue: 0
                                },
                                date: {
                                    start: new Date(parseInt(year), 0, 1),
                                },
                                range: 12,
                                scale: {
                                    color: {
                                        type: 'threshold',
                                        range: [
                                            '#30363d',
                                            '#0e4429',
                                            '#006d32',
                                            '#26a641',
                                            '#39d353',
                                        ],
                                        domain: [0.1, 2, 4, 6, 8],
                                    },
                                },
                                domain: {
                                    type: 'month',
                                    gutter: 6,
                                    label: { text: 'MMM', textAlign: 'start', position: 'top' },
                                },
                                subDomain: {
                                    type: 'ghDay',
                                    radius: 2,
                                    width: 18,
                                    height: 18,
                                    gutter: 6,
                                },
                            },
                            [
                                [
                                    Tooltip,
                                    {
                                        text: function (date, value, dayjsDate) {
                                            return (
                                                (value
                                                    ? value + (value === 1 ? ' hour' : ' hours')
                                                    : '0 hours') +
                                                ' on ' +
                                                dayjsDate.format('dddd, MMMM D, YYYY')
                                            );
                                        },
                                    },
                                ],
                                [
                                    CalendarLabel,
                                    {
                                        width: 30,
                                        textAlign: 'start',
                                        text: () => dayjs.weekdaysShort().map((d, i) => (i % 2 == 0 ? '' : d)),
                                        padding: [25, 0, 0, 0],
                                    },
                                ],
                            ]
                        );
                    });
            }

            async function loadData() {
                try {
                    console.log('Loading data from', DATA_FILE);
                    const response = await fetch(DATA_FILE);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${DATA_FILE}: ${response.statusText}`);
                    }
                    const data = await response.json();
                    console.log('Data loaded successfully', data);

                    renderStatistics(data.statistics);
                    renderChart(data.log);
                } catch (error) {
                    console.error('Error loading data:', error);
                    document.getElementById('stats-container').innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
                    document.getElementById('chart-container').innerHTML = '';
                }
            }

            // Load data when page loads
            try {
                console.log('Starting to load data...');
                loadData();
            } catch (error) {
                console.error('Error in main execution:', error);
            }

            // Auto-refresh data every 15 minutes (900000 milliseconds)
            setInterval(() => {
                console.log('Auto-refreshing data...');
                loadData();
            }, 15 * 60 * 1000);
        </script>
    </body>
</html>
